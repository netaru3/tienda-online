<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

    <div id="contenedor"></div>
    <button onclick="borrarproducto()"> eliminar producto</button>
<input type="text" name="editarimagen" id="editarnombre" placeholder="editar nombre">
<button onclick="enviar()" id="">enviar</button>
<br>

<form action="/editarimagen" method="post" enctype="multipart/form-data">
    <input type="file" name="editarimagen" id="editarimagen">
     <input type="hidden" name="nombre" value="<%= nombre %>">
    <input type="submit">
</form>
<input type="text" id="editardescripcion" placeholder="ingrese la nueva descripcion">
<button onclick="enviardescripcion()">enviar</button>
<input type="text" id="editarprecio" placeholder="ingrese el nuevo precio">
<button onclick="enviarprecio()">enviar</button>

<div id="comentarios"></div>
<script src="/socket.io/socket.io.js"></script>
    <script type="module">

      //-----declaraciones-----------------------
      let respuestas=[]


      //------------websocket--------------------
      let socket= io()
    socket.on("respuestas",function(respuestasdata){
     respuestas=respuestasdata;
     console.log(respuestas)
        })
 socket.on("comentarios", async function(comentarios){ 
     setTimeout(() => {
            mostrarcomentarios(comentarios)
     }, 50);
    

        })
        

       
      //----------------comentarios------------------

    window.enviarrespuesta= async function enviarrespuesta(usuario,comentario,numrespuesta){
     let respuestas= await fetch("/respuesta",{method:"POST",
      headers:{ "Content-Type":"application/json"},
      body: JSON.stringify({ usuario: usuario,
      comentario: comentario,
      producto:"<%= nombre %>",
      respuesta: document.getElementById(`respuesta${numrespuesta}`).value
      })
     })

     
      }
              function mostrarcomentarios(comentarios){
               let i=0
             const comentariodiv = document.getElementById("comentarios")
             comentariodiv.innerHTML=""
            for(let comentario of comentarios){
               let comentusuario= document.createElement("p")
               let coment= document.createElement("p")
               comentusuario.textContent= comentario.usuario;
               coment.textContent=comentario.comentario
               document.createElement("br")
                
              if(comentario.producto==="<%= nombre %>"){ comentariodiv.innerHTML +=`<p>${comentusuario.textContent} dice:</p>
              <p>${coment.textContent}</p>
              <input type="text" id="respuesta${i}" placeholder="ingrese una respuesta">
               <button onclick="enviarrespuesta('${comentusuario.textContent}','${coment.textContent}','${i}')">enviar</button>
              <br> `}

              ++i
              for(let respuesta of respuestas){
                if(respuesta.comentario===coment.textContent && respuesta.usuario_al_que_se_responde===comentusuario.textContent && respuesta.producto==="<%= nombre %>"){
                comentariodiv.innerHTML +=`
              <p>respuesta:${respuesta.respuesta}, @${respuesta.usuario_al_que_se_responde}</p>
              <br> `        
                }}
            }
            
        }
        
       
       window.enviar= async function enviar(){
           let url=  await fetch("/editarnombre",{method:"post",
            headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({nombre: document.getElementById("nombre").textContent,
    nombreeditado:document.getElementById("editarnombre").value
  })

 
        })
         let data= await url.json()

         window.location.href=`/producto/${data.nombreeditado}`

   
       }
        let productos=await fetch("/verproductos").then(function(res){return res.json()})
  
        window.enviarimagen=async function enviarimagen(){
            let url=  await fetch("/editarnombre",{method:"post",
            headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({nombre: document.getElementById("nombre").textContent,
    imageneditada:document.getElementById("editarimagen").file
  })

 
        })
         let data= await url.json()
            let file=document.getElementById("editarimagen").files[0]
            document.getElementById("imagen").src=URL.createObjectURL(file)
        }

        window.enviardescripcion= async function enviardescripcion(){
             let url=  await fetch("/editardescripcion",{method:"post",
            headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({descripcion: document.getElementById("descripcion").textContent,
    descripcioneditada:document.getElementById("editardescripcion").value,
    nombre: document.getElementById("nombre").textContent
  })

 
        })
         let data= await url.json()

   
            document.getElementById("descripcion").textContent=document.getElementById("editardescripcion").value
        }
        window.enviarprecio=async  function enviarprecio(){
                let url=  await fetch("/editarprecio",{method:"post",
            headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({precio: document.getElementById("precio").textContent,
    precioeditado:document.getElementById("editarprecio").value,
    nombre: document.getElementById("nombre").textContent
  })

 
        })
         let data= await url.json()

   
            document.getElementById("descripcion").textContent=document.getElementById("editardescripcion").value
            document.getElementById("precio").textContent=document.getElementById("editarprecio").value
        }
    console.log(productos)
 function mostrarproductos(producto){
        let nombre= document.createElement("h3")
        nombre.textContent=producto.producto_nombre;
        nombre.id="nombre"

        let precio= document.createElement("h4")
        precio.textContent="precio: "+producto.producto_precio
        precio.id="precio";

        let descripcion=document.createElement("p")
        descripcion.textContent=producto.producto_descripcion
        descripcion.id="descripcion"

   let imagen= document.createElement("img")
   imagen.id="imagen"
   imagen.src=`/${producto.producto_imagen}`
   imagen.width=500
   console.log(imagen.src)
 
   let contenedor= document.getElementById("contenedor")
   contenedor.appendChild(nombre)
   contenedor.appendChild(imagen)
   contenedor.appendChild(precio)
   contenedor.appendChild(descripcion)


}
function mostrarproducto(){for(let producto of productos){ if(producto.producto_nombre==="<%= nombre %>"){console.log(producto);
     mostrarproductos(producto)}}}


     mostrarproducto()

    window.borrarproducto=async function borrarproducto(){
      await fetch("/borrarproducto",{method:"POST",
         headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    producto_nombre:"<%= nombre %>"
  })
    
  
      })
      window.location.href="/tienda/admin"
    }
    </script>
</body>
</html>